---
# - name: "Creates backend app directory"
#   file:
#     path: ~/backend-application
#     state: directory

# - name: "Unarchive backend files"
#   unarchive:
#     src: ~/project/artifact.tar.gz
#     dest: ~/backend-application

- name: create directory 
  become: true
  file: 
    path: /home/ubuntu/web
    state: directory
    mode: 0755
- name: copy artifact
  become: true
  copy: 
    src: ~/project/artifact.tar.gz
    dest: /home/ubuntu/web/artifact.tar.gz


# - name: "upgrade packages."
#   become: true
#   apt:
#     upgrade: "yes"
# - name: "install dependencies."
#   become: true
#   apt:
#     name: ["nodejs", "npm"]
#     update_cache: yes
# - name: "install pm2"
#   become: true
#   npm:
#     name: pm2
#     global: yes
#     production: yes
#     state: present

- name: "upgrade packages."
  become: true
  apt:
    upgrade: "yes"
- name: "install dependencies."
  become: true
  apt:
    name: ["nodejs", "npm"]
    update_cache: yes
- name: "install pm2"
  become: true
  npm:
    name: pm2
    global: yes
    production: yes
    state: present

- name: "install npm packages"
  become: true
  command: npm install
  args:
    chdir: /home/ubuntu/web
- name: "compile npm packages"
  become: true
  command: npm run build
  args:
    chdir: /home/ubuntu/web
- name: "start server"
  become: true
  command: pm2 start npm -- run start
  args:
    chdir: /home/ubuntu/web
  environment:
     ENVIRONMENT: production
     TYPEORM_CONNECTION: "{{ lookup('env', 'TYPEORM_CONNECTION') }}"
     TYPEORM_MIGRATIONS_DIR: "./migrations"
     TYPEORM_MIGRATIONS: "./migrations/*.js"
     TYPEORM_ENTITIES: "./modules/domain/**/*.entity.js"
     TYPEORM_HOST: "{{ lookup('env', 'TYPEORM_HOST') }}"
     TYPEORM_PORT: "{{ lookup('env', 'TYPEORM_PORT') }}"
     TYPEORM_USERNAME: "{{ lookup('env', 'TYPEORM_USERNAME') }}"
     TYPEORM_PASSWORD: "{{ lookup('env', 'TYPEORM_PASSWORD') }}"
     TYPEORM_DATABASE: "{{ lookup('env', 'TYPEORM_DATABASE') }}"


# ---
# - name: create directory 
#   become: true
#   file: 
#     path: /home/ubuntu/web
#     state: directory
#     mode: 0755
# - name: copy artifact
#   become: true
#   copy: 
#     src: ~/project/artifact.tar.gz
#     dest: /home/ubuntu/web/artifact.tar.gz
# - name: "upgrade packages."
#   become: true
#   apt:
#     upgrade: "yes"

# - name: "NPM Install"
#   become: yes
#   shell: |
#     sudo apt update
#     sudo apt-get install -y npm
#     cd /home/ubuntu/app

# - name: Stop and delete already running server
#   ignore_errors: yes
#   shell: |
#     pm2 stop backend
#     pm2 delete backend

# - name: "Start backend"
#   become: yes
#   shell: |
#     cd /home/ubuntu/app
#     # npm run start
#     pm2 start npm -- start